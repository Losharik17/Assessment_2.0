{% extends "base.html"%}

{%  block app_content %}

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <div>
        <table class="table_sort">
            <thead>
            <tr>
                <th id="id" onclick="sort('#id')">№</th>
                <th id="username" onclick="sort('#username')">Участник</th>
                <th id="birthday" onclick="sort('#birthday')">Дата рождения</th>
                <th id="team" onclick="sort('#team')">Команда</th>

                {% set j = namespace(a=0) %}
                {% for parameter in ParName %}
                    <th id="sum_grade_{{ j.a }}" onclick="sort('#sum_grade_{{ j.a }}')">{{ parameter.name }}</th>
                    {% set j.a = j.a + 1 %}
                {% endfor %}
                <th id="sum_grade_all" onclick="sort('#sum_grade_all')">Общая оценка</th>
            </tr>
            </thead>

            <tbody>
            {% set j.a = 0 %}
            {% for user in users %}

                <tr id="number_str{{ j.a }}">
                    <td id="id{{ j.a }}">
                        {% if user.id %}
                            {{ user.id }}
                        {% else %}
                            –
                        {% endif %}
                    </td>

                    <td id="username{{ j.a }}">
                        {% if user.username %}
                            {{ user.username }}
                        {% else %}
                            –
                        {% endif %}
                    </td>

                    <td id="birthday{{ j.a }}">
                        {% if user.birthday %}
                            {{ user.birthday }}
                        {% else %}
                            –
                        {% endif %}
                    </td>

                    <td id="team{{ j.a }}">
                        {% if user.team %}
                            {{ user.team }}
                        {% else %}
                            –
                        {% endif %}
                    </td>
                    {% for i in range(10) %}
                        {% if user.__dict__['sum_grade_{}'.format(i)] %}
                            <td id="sum_grade_{{ i }}{{ j.a }}">
                                {% if user.__dict__['sum_grade_{}'.format(i)] == 0 %}
                                    —
                                {% else %}
                                    {{ user.__dict__['sum_grade_{}'.format(i)] }}
                                {% endif %}
                            </td>
                        {% endif %}
                    {% endfor %}

                    <td id="sum_grade_all{{ j.a }}">
                        {% if user.sum_grade_all == 0 %}
                            —
                        {% else %}
                            {{ user.sum_grade_all }}
                        {% endif %}
                    </td>
                </tr>

                {% set j.a = j.a + 1 %}

            {% endfor %}
            </tbody>
        </table>
    </div>

    <script>

    sort.sort_up = true
    sort.current_parameter = ''

    function sort(parameter) {
        if (sort.current_parameter === parameter.slice(1))
            sort.sort_up = !sort.sort_up
        else {
            sort.current_parameter = parameter.slice(1)
            sort.sort_up = true
        }

        $.post('/sort_users_table', {
            parameter: parameter.slice(1),
            sort_up: sort.sort_up
        }).done(
            function (response) {

                let users = JSON.parse(response['users'])
                let quantity = users.length

                for (let j = 0; j < quantity; j++) {
                    document.getElementById('id' + j).innerHTML = users[j].id ? users[j].id : '-';
                    document.getElementById('username' + j).innerHTML = users[j].username ? users[j].username : '-';
                    document.getElementById('birthday' + j).innerHTML = users[j].birthday != 'None' ? users[j].birthday : '-';
                    document.getElementById('team' + j).innerHTML = users[j].team != 'None' ? users[j].team : '-';

                    for (let i = 0; i < 10; i++)
                        if (document.getElementById('sum_grade_' + i + j))
                            document.getElementById('sum_grade_' + i + j).innerHTML = users[j]['sum_grade_' + i] != 'None' ? users[j]['sum_grade_' + i] : '-'

                    if (document.getElementById('sum_grade_all' + j))
                        document.getElementById('sum_grade_all' + j).innerHTML = users[j]['sum_grade_all'] != 'None' ? users[j]['sum_grade_all'] : '-'
                }
            }).fail(function () {
            alert("Error AJAX request")
        })
    }
    </script>



{% endblock %}
